# 基于前缀和算法实现直播间数据统计

****

## 背景

****

小班课直播间抽屉组件需求中，直播间抽屉/直播数据tab需要基于直播出勤的后台数据，统计直播期间每个时间点的学员状态（在直播间/前台/后台）。

****

## 目的

****

由于出勤数据记录较多，因此需要寻求一种算法可以在接近线性的时间复杂度之内完成每个时间段人数统计，提高接口性能。

****

## 场景抽象

****

出勤数据包含直播间用户（可能是老师、也可能是学生）进入直播间的时间信息和退出直播间的时间信息。例如：`userId, joinTime, outTime`

对于直播时的某个时间点 t1，需要找到所有 t1 时间点在直播间的人员出勤记录，过滤掉老师信息，只保留学生信息。

那么，我们将整个数据处理分为三部分：

- 先预处理所有的出勤记录，过滤掉老师信息
- 将所有出勤记录中的进入直播间时间、退出直播间时间作为时间点位聚合，记作统计的时间点
- 统计每个时间点位上的出勤记录

我们将统计场景单独抽象出数学模型：

- 已知有 N 个时间点，M 条记录
- 对于记录 Mi，包含时间点 `joinTime` 和 `outTime`
- 对于 Ni，要求统计所有 M 条记录中，满足 joinTime <= Ni <= outTime 的数量

由上述思路可知，难点在于如何快速统计出每个时间点位 Ni 满足要求的记录信息，如果对于每一条记录 Mi 更新所有的时间点位区间，在时间点位密集，出勤记录多的场景下，接口性能将会非常差。

****

## 算法选型

****

根据上面的数学模型，统计的本质是对于记录 Mi，需要快速更新区间 `joinTime` 到 `outTime` 的点位的信息。

适用这种情况的算法和数据结构如下：

- 前缀和与差分
- 树状数组、线段树

时间复杂度、空间复杂度分析：

- 前缀和与差分算法：
  - 时间复杂度：构建差分数组 O(N)、统计前缀和数组 O(N)
  - 空间复杂度：只需要构建一次差分数组，空间复杂度 O(N)
- 树状数组：
  - 时间复杂度：建树更新 O(NlogN)，统计操作 O(logN)
  - 空间复杂度：只需要构建一次树状数组，空间复杂度 O(N)
- 线段树：
  - 时间复杂度：递归建树 O(N)，统计操作 O(logN)
  - 空间复杂度：只需要构建一次树状数组，空间复杂度 O(2*N - 1)

综合时间复杂度和空间复杂度的考虑下，对于目前的场景，使用前缀和与差分算法就可以很好的解决当前问题，具体算法细节可以了解[1.5.1一维前缀和与一维差分](https://lys2021.com/2022/06/1-%e5%9f%ba%e7%a1%80%e7%ae%97%e6%b3%95%e5%88%9d%e8%af%86/)。

****

## 流程梳理

****

接下来利用前缀和算法，完整梳理一遍该解决方案的流程：

- 统计时间点位，去重，并且过滤出所有只跟学生有关的记录 O(NlogN)
- 时间点位按照时间从小到大排序，构造差分数组 O(NlogN)
- 遍历学生出勤记录，更新差分数组 O(N)
- 根据差分数组，构建前缀和数组统计区间信息 O(N)

综合时间复杂度 O(NlogN)，实际场景下，N <= 2 * M。







